<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hangul Random Syllable Generator</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :focus-visible { outline: 2px solid #111827; outline-offset: 2px; }
    .switch { position: relative; width: 44px; height: 24px; background: #e5e7eb; border-radius: 9999px; transition: background .2s; }
    .switch:has(input:checked) { background: #111827; }
    .switch input { display: none; }
    .knob { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 9999px; transition: transform .2s; }
    .switch:has(input:checked) .knob { transform: translateX(20px); }
    .card { border: 1px solid #e5e7eb; border-radius: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); background: rgba(255, 255, 255, 0.7); }
    .btn { border-radius: 1rem; padding: .5rem .9rem; border: 1px solid #e5e7eb; background: white; opacity: 1; color: black; }
    .btn.primary { background: #111827; color: white; border-color: #111827; }
    .btn:hover { box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .icon { width: 18px; height: 18px; }
    input[type="number"], select { color: black; }
    input[type="range"] { color: black; }
    input[type="number"] { color: #000 !important; }
    select option { color: #000; }
    h1 { 
      font-family: 'Press Start 2P', cursive !important; 
      color: white !important; 
      text-shadow: -2px -2px 0 #3498db, 2px -2px 0 #3498db, -2px 2px 0 #3498db, 2px 2px 0 #3498db !important; 
    }
    .card .font-semibold {
      font-family: 'Press Start 2P', cursive !important;
      text-shadow: 
        -2px -2px 0 #180d1c, 2px -2px 0 #180d1c, -2px 2px 0 #180d1c, 2px 2px 0 #180d1c,
        -2px 0px 0 #180d1c, 2px 0px 0 #180d1c, 0px -2px 0 #180d1c, 0px 2px 0 #180d1c,
        -1px -1px 0 #180d1c, 1px -1px 0 #180d1c, -1px 1px 0 #180d1c, 1px 1px 0 #180d1c !important;
    }
    .community-text {
      font-family: 'Press Start 2P', cursive !important;
      color: white;
      text-shadow: 
        -1px -1px 0 #ff7777, 1px -1px 0 #ff7777, -1px 1px 0 #ff7777, 1px 1px 0 #ff7777,
        -1px 0px 0 #ff7777, 1px 0px 0 #ff7777, 0px -1px 0 #ff7777, 0px 1px 0 #ff7777,
        -0.5px -0.5px 0 #ff7777, 0.5px -0.5px 0 #ff7777, -0.5px 0.5px 0 #ff7777, 0.5px 0.5px 0 #ff7777,
        -0.5px 0px 0 #ff7777, 0.5px 0px 0 #ff7777, 0px -0.5px 0 #ff7777, 0px 0.5px 0 #ff7777;
      font-size: 1.5rem;
      line-height: 1.6;
    }
    .community-link {
      color: #ffff00 !important;
      text-shadow: 
        -1px -1px 0 #ff8800, 1px -1px 0 #ff8800, -1px 1px 0 #ff8800, 1px 1px 0 #ff8800,
        -1px 0px 0 #ff8800, 1px 0px 0 #ff8800, 0px -1px 0 #ff8800, 0px 1px 0 #ff8800,
        -0.5px -0.5px 0 #ff8800, 0.5px -0.5px 0 #ff8800, -0.5px 0.5px 0 #ff8800, 0.5px 0.5px 0 #ff8800,
        -0.5px 0px 0 #ff8800, 0.5px 0px 0 #ff8800, 0px -0.5px 0 #ff8800, 0px 0.5px 0 #ff8800 !important;
      text-decoration: none;
    }
    .community-link:hover {
      text-shadow: 
        -1.5px -1.5px 0 #ff8800, 1.5px -1.5px 0 #ff8800, -1.5px 1.5px 0 #ff8800, 1.5px 1.5px 0 #ff8800,
        -1.5px 0px 0 #ff8800, 1.5px 0px 0 #ff8800, 0px -1.5px 0 #ff8800, 0px 1.5px 0 #ff8800,
        -1px -1px 0 #ff8800, 1px -1px 0 #ff8800, -1px 1px 0 #ff8800, 1px 1px 0 #ff8800 !important;
    }
  </style>
</head>
<body class="min-h-screen w-full text-white p-6" style="background: url('https://cdn.shopify.com/s/files/1/0674/6747/7282/files/sky.png?v=1750990355') repeat;">
  <div id="app" class="mx-auto max-w-6xl"></div>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
  const { useState, useMemo, useEffect } = React;

  const CHOSEONG = [
    { jamo: "ㄱ", idx: 0 },{ jamo: "ㄴ", idx: 2 },{ jamo: "ㄷ", idx: 3 },{ jamo: "ㄹ", idx: 5 },
    { jamo: "ㅁ", idx: 6 },{ jamo: "ㅂ", idx: 7 },{ jamo: "ㅅ", idx: 9 },{ jamo: "ㅇ", idx: 11 },
    { jamo: "ㅈ", idx: 12 },{ jamo: "ㅊ", idx: 14 },{ jamo: "ㅋ", idx: 15 },{ jamo: "ㅌ", idx: 16 },
    { jamo: "ㅍ", idx: 17 },{ jamo: "ㅎ", idx: 18 },
  ];
  const ALL_VOWELS = [
    { jamo: "ㅏ", idx: 0 },{ jamo: "ㅑ", idx: 2 },{ jamo: "ㅓ", idx: 4 },{ jamo: "ㅕ", idx: 6 },
    { jamo: "ㅗ", idx: 8 },{ jamo: "ㅛ", idx: 12 },{ jamo: "ㅜ", idx: 13 },{ jamo: "ㅠ", idx: 17 },
    { jamo: "ㅡ", idx: 18 },{ jamo: "ㅣ", idx: 20 },
  ];
  const BATCHIM = [
    { jamo: "(none)", idx: 0 },{ jamo: "ㄱ", idx: 1 },{ jamo: "ㄴ", idx: 4 },{ jamo: "ㄷ", idx: 7 },
    { jamo: "ㄹ", idx: 8 },{ jamo: "ㅁ", idx: 16 },{ jamo: "ㅂ", idx: 17 },{ jamo: "ㅇ", idx: 21 },
    { jamo: "ㅅ", idx: 19 },{ jamo: "ㅆ", idx: 20 },{ jamo: "ㅈ", idx: 22 },{ jamo: "ㅊ", idx: 23 },
    { jamo: "ㅋ", idx: 24 },{ jamo: "ㅌ", idx: 25 },{ jamo: "ㅍ", idx: 26 },{ jamo: "ㅎ", idx: 27 },
  ];

  function composeHangul(choIdx, jungIdx, jongIdx) {
    const base = 0xac00;
    const codePoint = base + (choIdx * 21 + jungIdx) * 28 + jongIdx;
    return String.fromCharCode(codePoint);
  }

  function useSyllableSet(count, ensureAllInitials, vowels, finals, allowNoFinal) {
    return React.useMemo(() => {
      const out = [];
      const finalsFiltered = allowNoFinal ? finals : finals.filter(f => f.idx !== 0);
      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
      if (ensureAllInitials) {
        for (const ch of CHOSEONG) {
          const v = pick(vowels);
          const j = pick(finalsFiltered);
          out.push({
            syll: composeHangul(ch.idx, v.idx, j.idx),
            parts: `${ch.jamo}${v.jamo}${j.jamo === "(none)" ? "" : j.jamo}`,
          });
        }
      }
      while (out.length < count) {
        const ch = pick(CHOSEONG);
        const v = pick(vowels);
        const j = pick(finalsFiltered);
        out.push({
          syll: composeHangul(ch.idx, v.idx, j.idx),
          parts: `${ch.jamo}${v.jamo}${j.jamo === "(none)" ? "" : j.jamo}`,
        });
      }
      for (let i = out.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [out[i], out[j]] = [out[j], out[i]];
      }
      return out.slice(0, count);
    }, [count, ensureAllInitials, vowels, finals, allowNoFinal]);
  }

  function getAllVoices(){
    if (typeof window === 'undefined' || !('speechSynthesis' in window)) return [];
    return window.speechSynthesis.getVoices();
  }
  function filterKoreanVoices(voices){
    const isKo = (v) => (v.lang||'').toLowerCase().startsWith('ko');
    const inName = (v) => /korean|한국어|국어|ko-kr/i.test(v.name||'');
    return voices.filter(v => isKo(v) || inName(v));
  }

  // Order voices: Google first, Yuna second (if they exist), then the rest.
  function orderVoices(voices){
    const isGoogleKo = (v) => /google/i.test(v.name||'') && /(korean|ko-kr|한국|국어)/i.test((v.name||'') + ' ' + (v.lang||''));
    const isYuna = (v) => /yuna/i.test(v.name||'');
    const google = voices.find(isGoogleKo) || null;
    const yuna = voices.find(isYuna) || null;

    const ordered = [];
    if (google) ordered.push(google);
    if (yuna && (!google || yuna.name !== google.name)) ordered.push(yuna);

    // Add the rest (deduped)
    voices.forEach(v => {
      if (!ordered.find(o => o.name === v.name)) ordered.push(v);
    });
    return ordered;
  }

  function speakLocal(text, voice, rate=0.95, pitch=1.0){
    if (typeof window === 'undefined' || !('speechSynthesis' in window) || !text) return;
    const synth = window.speechSynthesis;
    try{
      const u = new SpeechSynthesisUtterance(text);
      if (voice) u.voice = voice;
      u.lang = (voice && voice.lang) || 'ko-KR';
      u.rate = rate; u.pitch = pitch;
      synth.cancel();
      synth.speak(u);
    }catch(e){ console.error(e); }
  }
  function stopSpeaking(){ if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }
  function readAllQueuedLocal(syllables, voice, rate, pitch, pauseMs){
    if (!('speechSynthesis' in window)) return;
    const synth = window.speechSynthesis; synth.cancel();
    let i = 0;
    const speakNext = () => {
      if (i >= syllables.length) return;
      const u = new SpeechSynthesisUtterance(syllables[i]);
      if (voice) u.voice = voice;
      u.lang = (voice && voice.lang) || 'ko-KR';
      u.rate = rate; u.pitch = pitch;
      u.onend = () => setTimeout(() => { i += 1; speakNext(); }, pauseMs);
      synth.speak(u);
    };
    speakNext();
  }

  function App(){
    const [count, setCount] = useState(28);
    const [ensureAllInitials, setEnsureAllInitials] = useState(true);
    const [allowNoFinal, setAllowNoFinal] = useState(false);
    const [enabledVowels, setEnabledVowels] = useState(() => Object.fromEntries(ALL_VOWELS.map(v => [v.jamo, true])));
    const [enabledFinals, setEnabledFinals] = useState(() => {
      const defaults = ["ㄱ","ㄴ","ㄷ","ㄹ","ㅁ","ㅂ","ㅇ"]; const initial = {}; BATCHIM.forEach(f=>initial[f.jamo]=false); defaults.forEach(k=>initial[k]=true); return initial;
    });

    const [voiceName, setVoiceName] = useState(''); // no "auto"
    const [rate, setRate] = useState(0.9);
    const [pitch, setPitch] = useState(1.0);
    const [pauseMs, setPauseMs] = useState(180);
    const [crispSingle, setCrispSingle] = useState(true);
    const [voices, setVoices] = useState([]);

    useEffect(() => {
      const load = () => setVoices(filterKoreanVoices(getAllVoices()));
      load();
      if ('speechSynthesis' in window){
        window.speechSynthesis.onvoiceschanged = load;
        const t = setTimeout(load, 600);
        return () => { clearTimeout(t); window.speechSynthesis.onvoiceschanged = null; };
      }
    }, []);

    const orderedVoices = useMemo(() => orderVoices(voices), [voices]);

    // If nothing selected yet, default to the first (which is Google if present).
    useEffect(() => {
      if (!voiceName && orderedVoices.length) {
        setVoiceName(orderedVoices[0].name);
      }
    }, [orderedVoices, voiceName]);

    const selectedVoice = useMemo(() => {
      if (!orderedVoices.length) return null;
      return orderedVoices.find(v => v.name === voiceName) || orderedVoices[0] || null;
    }, [orderedVoices, voiceName]);

    const vowels = useMemo(() => ALL_VOWELS.filter(v => enabledVowels[v.jamo]), [enabledVowels]);
    const finals = useMemo(() => BATCHIM.filter(f => enabledFinals[f.jamo]), [enabledFinals]);

    const data = useSyllableSet(
      count, ensureAllInitials,
      vowels.length ? vowels : ALL_VOWELS,
      finals.length ? finals : BATCHIM.filter(f => f.idx !== 0),
      allowNoFinal
    );

    const toggleMap = (setter, key) => setter(prev => ({ ...prev, [key]: !prev[key] }));

    const downloadCSV = () => {
      const csv = "syllable,parts\n" + data.map(d => `${d.syll},${d.parts}`).join("\n");
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'hangul_random_syllables.csv'; a.click(); URL.revokeObjectURL(url);
    };

    const refreshVoices = () => setVoices(filterKoreanVoices(getAllVoices()));

    return (
      React.createElement('div', { className: 'space-y-6' },
        React.createElement('div', { className: 'text-center mb-6' },
          React.createElement('img', { 
            src: 'https://cdn.shopify.com/s/files/1/0674/6747/7282/files/logo555.png?v=1757969221',
            alt: 'Logo',
            className: 'mx-auto max-w-xs h-auto'
          })
        ),
        React.createElement('div', { className: 'text-center mb-4' },
          React.createElement('p', { className: 'community-text' },
            'Want more? Click ',
            React.createElement('a', { 
              href: 'https://cyinthehouse.github.io/freecommunity/',
              target: '_blank',
              className: 'community-link'
            }, 'HERE'),
            ' to join the free community!'
          )
        ),
        React.createElement('div', { className: 'flex items-center justify-between gap-4' },
          React.createElement('h1', { className: 'text-sm md:text-lg font-bold' }, 'Hangul Random Syllable Generator'),
          React.createElement('div', { className: 'flex items-center gap-2' },
            React.createElement('button', { className: 'btn', onClick: () => location.reload() }, 'Reset'),
            React.createElement('button', { className: 'btn primary', onClick: downloadCSV }, 'Export CSV')
          )
        ),

        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'p-5 border-b' },
            React.createElement('div', { className: 'flex items-center gap-2 font-semibold' }, 'Settings')
          ),
          React.createElement('div', { className: 'p-5 space-y-6' },
            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
              // column 1
              React.createElement('div', { className: 'space-y-3' },
                React.createElement('label', { className: 'text-sm font-bold' }, 'How many syllables?'),
                React.createElement('div', { className: 'flex items-center gap-4' },
                  React.createElement('input', { type: 'range', min: 14, max: 140, step: 1, value: count, onChange: e => setCount(parseInt(e.target.value || '28')), className: 'w-full' }),
                  React.createElement('input', { type: 'number', min: 14, max: 140, value: count, onChange: e => setCount(parseInt(e.target.value || '28')), className: 'w-24 border rounded-xl px-3 py-2 text-black' })
                ),
                React.createElement('div', { className: 'flex items-center justify-between' },
                  React.createElement('label', { className: 'text-sm' }, 'Ensure all initials (ㄱ–ㅎ) appear'),
                  React.createElement('label', { className: 'switch' },
                    React.createElement('input', { type: 'checkbox', checked: ensureAllInitials, onChange: e => setEnsureAllInitials(e.target.checked) }),
                    React.createElement('span', { className: 'knob' })
                  )
                ),
                React.createElement('div', { className: 'flex items-center justify-between' },
                  React.createElement('label', { className: 'text-sm' }, 'Allow no final (CV)'),
                  React.createElement('label', { className: 'switch' },
                    React.createElement('input', { type: 'checkbox', checked: allowNoFinal, onChange: e => setAllowNoFinal(e.target.checked) }),
                    React.createElement('span', { className: 'knob' })
                  )
                )
              ),

              // column 2: vowels
              React.createElement('div', { className: 'space-y-2' },
                React.createElement('label', { className: 'text-sm font-bold' }, 'Vowels (중성)'),
                React.createElement('div', { className: 'grid grid-cols-10 gap-2' },
                  ALL_VOWELS.map(v => React.createElement('button', {
                    key: v.jamo,
                    onClick: () => toggleMap(setEnabledVowels, v.jamo),
                    className: `border rounded-xl py-2 px-3 whitespace-nowrap inline-flex items-center justify-center ${enabledVowels[v.jamo] ? 'bg-gray-900 text-white' : 'bg-white text-black'}`
                  }, v.jamo))
                )
              ),

              // column 3: finals
              React.createElement('div', { className: 'space-y-2' },
                React.createElement('label', { className: 'text-sm font-bold' }, 'Finals / 받침 (종성)'),
                React.createElement('div', { className: 'grid grid-cols-8 gap-2' },
                  BATCHIM.map(f => React.createElement('button', {
                    key: f.jamo,
                    onClick: () => toggleMap(setEnabledFinals, f.jamo),
                    className: `border rounded-xl py-2 px-3 whitespace-nowrap inline-flex items-center justify-center ${enabledFinals[f.jamo] ? 'bg-gray-900 text-white' : 'bg-white text-black'}`
                  }, f.jamo))
                ),
                React.createElement('p', { className: 'text-xs text-gray-500' }, React.createElement('strong', null, 'Tip:'), ' For focused CVC practice, enable ㄱ ㄴ ㄷ ㄹ ㅁ ㅂ ㅇ and turn off "Allow no final".')
              )
            ),

            // speech settings
            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6 pt-2 border-t' },
              React.createElement('div', { className: 'space-y-2' },
                React.createElement('label', { className: 'text-sm font-bold' }, 'Voice (음성)'),
                React.createElement('div', { className: 'flex items-center gap-2 mt-2' },
                  React.createElement('select', {
                      className: 'border rounded-xl px-3 py-2 w-full text-black bg-white [color-scheme:light]',
                      value: voiceName || (orderedVoices[0]?.name || ''),
                      onChange: e => setVoiceName(e.target.value)
                    },
                    orderedVoices.map((v, idx) => React.createElement('option', { key: idx, value: v.name }, `${v.name} ${v.lang ? '('+v.lang+')' : ''}`))
                  ),
                  React.createElement('button', { className: 'btn', onClick: refreshVoices, title: 'Reload voices' }, 'Reload'),
                  React.createElement('button', { className: 'btn primary', onClick: () => speakLocal('가.', selectedVoice, rate, pitch) }, 'Test voice')
                ),
                React.createElement('p', { className: 'text-xs text-gray-500' }, React.createElement('strong', null, 'Tip:'), ' We recommend selecting Google from the dropdown menu above.')
              ),
              React.createElement('div', { className: 'space-y-2' },
                React.createElement('label', { className: 'text-sm' }, `Speed (속도) ${rate.toFixed(2)}`),
                React.createElement('input', { type: 'range', min: 0.6, max: 1.2, step: 0.01, value: rate, onChange: e => setRate(parseFloat(e.target.value)), className: 'w-full' }),
                React.createElement('label', { className: 'text-sm' }, `Pause between syllables (ms): ${pauseMs}ms`),
                React.createElement('input', { type: 'range', min: 80, max: 400, step: 10, value: pauseMs, onChange: e => setPauseMs(parseInt(e.target.value)), className: 'w-full' })
              ),
              React.createElement('div', { className: 'space-y-2' },
                React.createElement('div', { className: 'flex items-center justify-between' },
                  React.createElement('label', { className: 'text-sm' }, 'Crisp single-syllable mode (adds a period)'),
                  React.createElement('label', { className: 'switch' },
                    React.createElement('input', { type: 'checkbox', checked: crispSingle, onChange: e => setCrispSingle(e.target.checked) }),
                    React.createElement('span', { className: 'knob' })
                  )
                ),
                React.createElement('label', { className: 'text-sm' }, `Pitch (톤) ${pitch.toFixed(2)}`),
                React.createElement('input', { type: 'range', min: 0.8, max: 1.2, step: 0.01, value: pitch, onChange: e => setPitch(parseFloat(e.target.value)), className: 'w-full' })
              )
            )
          )
        ),

        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'p-5 border-b' },
            React.createElement('div', { className: 'flex items-center gap-2 font-semibold' }, 'Random Mix')
          ),
          React.createElement('div', { className: 'p-5' },
            React.createElement('div', { className: 'grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3' },
              data.map((d, i) => React.createElement('button', {
                key: i,
                className: 'aspect-square flex items-center justify-center text-2xl md:text-3xl border rounded-2xl hover:shadow focus:outline-none transition-transform',
                title: `${d.parts} — Click to hear`,
                onClick: () => speakLocal((crispSingle ? d.syll + '.' : d.syll), selectedVoice, rate, pitch)
              }, d.syll))
            ),
            React.createElement('div', { className: 'mt-4 flex items-center justify-center gap-3' },
              React.createElement('button', { className: 'btn primary', onClick: () => { setCount(c => (c >= 14 ? c - 0.0001 : c + 0.0001)); } }, 'Shuffle'),
              React.createElement('button', { className: 'btn', onClick: () => readAllQueuedLocal(data.map(d=>d.syll), selectedVoice, rate, pitch, pauseMs) }, 'Read All (queued)'),
              React.createElement('button', { className: 'btn', onClick: stopSpeaking }, 'Stop')
            )
          )
        ),

        React.createElement('div', { className: 'text-sm text-gray-500' }, 
          '\u00A9 2025 ',
          React.createElement('span', { style: { color: '#3498db' } }, 'Korean'),
          React.createElement('span', { style: { color: '#ff7777' } }, 'Learnin'),
          '. All rights reserved. \u2022 ',
          React.createElement('strong', null, 'Tip:'),
          ' Click any tile to hear it. If no sound, pick a specific voice or hit Reload voices.'
        )
      )
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('app'));
  root.render(React.createElement(App));
  </script>
</body>
</html>
